---
/**
 * NewsCard - Komponenta pro zobrazení jedné aktuality
 *
 * Zobrazuje kartu aktuality s ikonou, nadpisem, datem a zkráceným obsahem.
 * Při kliknutí otevře modal s plným obsahem.
 * Používá se jak v gridu na /aktuality, tak v carouselu na homepage.
 *
 * @component
 */
import { Icon } from 'astro-icon/components';
import { formatDateShort } from '../../utils/dateFormat';
import { getNewsCardClasses, getNewsIconBg, getNewsCtaClasses } from '../../utils/newsColors';
import type { CollectionEntry } from 'astro:content';

interface Props {
  /** Aktualita z content kolekce */
  news: CollectionEntry<'news'>;
  /** Varianta zobrazení - carousel má pevnou šířku, grid reaguje na mřížku */
  variant?: 'carousel' | 'grid';
}

const { news, variant = 'grid' } = Astro.props;

const modalId = `news-${news.id}`;

// Renderovat markdown obsah
const { Content } = await news.render();

// Získat styly podle barvy
const cardClasses = getNewsCardClasses(news.data.color);
const iconBgClass = getNewsIconBg(news.data.color);
const ctaClasses = getNewsCtaClasses(news.data.color);

// Šířka podle varianty
const widthClasses = variant === 'carousel'
  ? 'flex-none w-[300px] md:w-[360px] snap-start'
  : 'h-full';
---

<article
  class:list={[
    'rounded-xl border-2 p-6 transition-all shadow-sm hover:shadow-lg cursor-pointer group flex flex-col',
    'bg-white/80 supports-[backdrop-filter]:bg-white/60 backdrop-blur-md',
    widthClasses,
    cardClasses
  ]}
  data-modal-id={modalId}
  role="button"
  tabindex="0"
>
  <!-- Header s ikonou a datem -->
  <div class="flex items-start gap-4 mb-4">
    <div class:list={[
      'w-12 h-12 rounded-xl flex items-center justify-center shrink-0 shadow-lg',
      iconBgClass
    ]}>
      <Icon name={news.data.icon} class="w-6 h-6 text-white" />
    </div>
    <div class="flex-1 min-w-0">
      <h3 class="font-bold text-lg text-gray-900 leading-tight mb-1 group-hover:text-primary transition-colors">
        {news.data.title}
      </h3>
      <time class="text-xs text-gray-500">
        {formatDateShort(news.data.date.toISOString())}
      </time>
    </div>
  </div>

  <!-- Preview obsahu - zkrácený -->
  <div class="flex-1">
    <div class="prose prose-sm max-w-none text-gray-700 line-clamp-4 [&>p]:mb-2 [&>strong]:text-gray-900 [&>strong]:font-semibold">
      <Content />
    </div>
  </div>

  <!-- CTA -->
  <div class="mt-4 pt-4 border-t border-gray-200">
    <div class:list={[
      'flex items-center justify-between text-sm font-semibold transition-colors',
      ctaClasses
    ]}>
      <span>Zobrazit detail</span>
      <Icon name="mdi:arrow-right" class="w-5 h-5" />
    </div>
  </div>
</article>

<script define:vars={{ modalId }}>
  // Inicializace po načtení stránky
  function initCard() {
    const card = document.querySelector(`[data-modal-id="${modalId}"]`);

    if (!card) return;

    // Funkce pro otevření modalu
    function openModal() {
      const modal = document.getElementById(`modal-${modalId}`);
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    // Click event
    card.addEventListener('click', openModal);

    // Keyboard accessibility
    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openModal();
      }
    });
  }

  // Inicializovat při načtení i po view transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCard);
  } else {
    initCard();
  }

  document.addEventListener('astro:page-load', initCard);
</script>
