---
/**
 * TodayHoursCard - Karta zobrazující dnešní ordinační hodiny
 *
 * Zobrazuje aktuální den a otevírací hodiny s případným speciálním oznámením.
 * Barvy se mění podle typu oznámení (warning, urgent, info).
 */
import { Icon } from 'astro-icon/components';
import ClosureNoticeCard from '../common/ClosureNoticeCard.astro';
import { getTodayActualHours, getSpecialNoticeDisplay } from '../../utils/openingHours';
import { getNoticeColors, getSpecialNoticeVisualConfig } from '../../utils/noticeColors';
import specialNoticeClosure from '../../data/closureNotice';

// getTodayActualHours ignoruje showEarly flag (zobrazí warning jen když platí DNES)
const todayInfo = getTodayActualHours();
const specialNoticeDisplay = getSpecialNoticeDisplay();
const isEarlyWarning = specialNoticeDisplay.isEarlyWarning;

// Pro zobrazení closure card jen když není early warning (tj. když to platí DNES)
const closureInfo = !isEarlyWarning && specialNoticeDisplay.isClosed ? specialNoticeDisplay.closureInfo : null;
const closureCardInfo = closureInfo ?? specialNoticeClosure;
const colors = todayInfo.isModified ? getNoticeColors(todayInfo.noticeType) : null;

// Pro early warning oznámení
const earlyNoticeConfig = specialNoticeDisplay.notice ? getSpecialNoticeVisualConfig(specialNoticeDisplay.notice.type) : null;
const displayHours = todayInfo.hours ?? "Zavřeno";
const hoursClass = todayInfo.isModified
  ? colors?.text ?? "text-primary"
  : todayInfo.isClosed
    ? "text-gray-600"
    : "text-primary";
const noticeVisible = Boolean(todayInfo.isModified && todayInfo.notice);
const todayCardDefault = "rounded-2xl shadow-lg p-8 border-2 bg-white border-[#5085c6]/30";
const todayIconDefault = "w-12 h-12 rounded-full flex items-center justify-center relative bg-[#5085c6]";
const todayHoursDefault = "text-primary";
---

<div class:list={[
  "rounded-2xl shadow-lg p-8 border-2",
  todayInfo.isModified ? `${colors?.bg} ${colors?.border}` : "bg-white border-[#5085c6]/30"
]} data-opening-today-card data-opening-node="today-card" data-opening-default-classes={todayCardDefault}>
  <div class="flex items-center gap-4 mb-4">
    <div class:list={[
      "w-12 h-12 rounded-full flex items-center justify-center relative",
      todayInfo.isModified ? colors?.icon : "bg-[#5085c6]"
    ]} data-opening-node="today-icon" data-opening-default-classes={todayIconDefault}>
      <Icon
        name="mdi:clock-outline"
        class:list={[
          "w-6 h-6 text-white",
          todayInfo.isModified ? "hidden" : ""
        ]}
        aria-hidden="true"
        data-opening-icon="default"
      />
      <Icon
        name="mdi:alert-circle-outline"
        class:list={[
          "w-6 h-6 text-white",
          todayInfo.isModified ? "" : "hidden"
        ]}
        aria-hidden="true"
        data-opening-icon="modified"
      />
    </div>
    <div>
      <h2
        class="text-2xl font-bold text-gray-900"
        data-opening-title
      >
        {todayInfo.title}
      </h2>
      <p
        class="text-gray-600"
        data-opening-date
      >
        {new Date().toLocaleDateString('cs-CZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
      </p>
    </div>
  </div>

  <!-- Hodiny (pokud existují) -->
  {(todayInfo.hours || todayInfo.isClosed) && (
    <div
      class:list={[
        "text-3xl font-bold mb-2",
        hoursClass
      ]}
      data-opening-hours
      data-opening-node="today-hours"
      data-opening-default-classes={todayHoursDefault}
    >
      {displayHours}
    </div>
  )}

  <!-- Zpráva/oznámení -->
  <div class:list={[
    "mt-4 p-4 border-l-4 rounded",
    noticeVisible ? `${colors?.infoBanner ?? ""} ${colors?.infoBannerBorder ?? ""}` : "hidden"
  ]} data-opening-node="today-notice" data-opening-default-classes="hidden">
    <p class:list={[
      "text-sm font-medium",
      noticeVisible ? colors?.description ?? "text-[#5085c6]" : "text-[#5085c6]"
    ]} data-opening-node="today-notice-text" data-opening-default-classes="text-[#5085c6]">
      <Icon name="mdi:information" class="w-4 h-4 inline mr-1" aria-hidden="true" />
      <span data-opening-notice-text>{todayInfo.notice ?? ''}</span>
    </p>
  </div>

</div>

<!-- Closure card (zobrazí se JEN když to platí DNES, ne při early warning) -->
<div class:list={[
  "mt-4 p-5 rounded-xl border border-orange-200 bg-orange-50 shadow-sm",
  closureInfo ? "" : "hidden"
]}>
  <ClosureNoticeCard info={closureCardInfo} />
</div>

<!-- Early Warning oznámení (zobrazí se JEN když showEarly=true a dnes < validFrom) -->
{isEarlyWarning && specialNoticeDisplay.notice && earlyNoticeConfig && (
  <div class={`mt-4 bg-white rounded-2xl shadow-lg border-2 ${earlyNoticeConfig.border} p-5 relative`}>
    <div class={`absolute top-4 right-4 w-10 h-10 bg-linear-to-br ${earlyNoticeConfig.iconGradient} rounded-lg flex items-center justify-center opacity-80`}>
      <Icon name={earlyNoticeConfig.iconName} class="w-6 h-6 text-white" />
    </div>
    <div class="pr-14">
      <h3 class="font-bold text-lg text-gray-900 mb-2">
        Důležité oznámení
      </h3>
      {specialNoticeDisplay.notice.message && (
        <p class="text-gray-700 text-sm leading-relaxed">
          {specialNoticeDisplay.notice.message}
        </p>
      )}
      {specialNoticeDisplay.displayHours && (
        <div class={`inline-flex items-center gap-2 ${earlyNoticeConfig.badgeText} ${earlyNoticeConfig.badgeBg} px-3 py-1.5 rounded-lg text-sm ${specialNoticeDisplay.notice.message ? 'mt-3' : ''}`}>
          <Icon name="mdi:clock-outline" class="w-4 h-4" />
          <span class="font-semibold">{specialNoticeDisplay.displayHours}</span>
        </div>
      )}
      {specialNoticeDisplay.closureInfo && (
        <div class="mt-4 p-4 rounded-xl border border-orange-200 bg-white/80">
          <ClosureNoticeCard info={specialNoticeDisplay.closureInfo} />
        </div>
      )}
    </div>
  </div>
)}
