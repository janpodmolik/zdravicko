---
import { Icon } from 'astro-icon/components';
import Lightbox from '../gallery/Lightbox.astro';
import GalleryButton from '../gallery/GalleryButton.astro';
import RoomInfoModal from '../modals/RoomInfoModal.astro';
import {
  ordinaceNemocneGallery,
  ordinaceZdraveGallery,
  cekarnaNenocneGallery,
  cekarnaZdraveGallery,
  hernaGallery
} from '../../data/galleries';
import type { GalleryId } from '../../types/gallery';

interface ColorScheme {
  bg: string;
  border: string;
  text: string;
  iconBg: string;
}

interface Facility {
  title: string;
  description: string;
  icon: string;
  imageAlt: string;
  galleryId: GalleryId;
  color: ColorScheme;
}

interface WaitingRoom {
  id: string;
  title: string;
  icon: string;
  emojiIcon: string;
  description: string;
  detailedContent: string;
  galleryId: GalleryId;
}

const facilities: Facility[] = [
  {
    title: 'Ordinace pro nemocnÃ© dÄ›ti',
    description: 'SpeciÃ¡lnÃ­ ordinace urÄenÃ¡ pro vyÅ¡etÅ™enÃ­ akutnÄ› nemocnÃ½ch dÄ›tÃ­. OddÄ›lenÃ© prostÅ™edÃ­ minimalizuje riziko pÅ™enosu infekce na ostatnÃ­ pacienty.',
    icon: 'mdi:hospital-box',
    imageAlt: 'Ordinace pro nemocnÃ© dÄ›ti',
    galleryId: 'ordinace-nemocne',
    color: {
      bg: 'bg-red-50',
      border: 'border-red-200',
      text: 'text-red-600',
      iconBg: 'bg-red-600'
    }
  },
  {
    title: 'Ordinace pro zdravÃ© dÄ›ti',
    description: 'Ordinace urÄenÃ¡ pro preventivnÃ­ prohlÃ­dky, oÄkovÃ¡nÃ­ a kontroly zdravÃ½ch dÄ›tÃ­ vÄetnÄ› miminek. ÄŒistÃ© a bezpeÄnÃ© prostÅ™edÃ­ bez kontaktu s nemocnÃ½mi.',
    icon: 'mdi:baby-face-outline',
    imageAlt: 'Ordinace pro zdravÃ¡ miminka',
    galleryId: 'ordinace-zdrave',
    color: {
      bg: 'bg-green-50',
      border: 'border-green-200',
      text: 'text-green-600',
      iconBg: 'bg-green-600'
    }
  }
];

const waitingRooms: WaitingRoom[] = [
  {
    id: 'room-sick',
    title: 'ÄŒekÃ¡rna pro nemocnÃ©',
    icon: 'mdi:seat',
    emojiIcon: 'ğŸ˜·',
    description: 'OddÄ›lenÃ¡ ÄekÃ¡rna pro akutnÄ› nemocnÃ© dÄ›ti',
    detailedContent: `
      <h3 class="text-lg font-bold text-gray-900 mb-3">BezpeÄnÃ½ prostor pro nemocnÃ© dÄ›ti</h3>
      <p class="mb-4">ÄŒekÃ¡rna pro nemocnÃ© je oddÄ›lena od zbytku ordinace, aby se minimalizovalo riziko pÅ™enosu infekce na ostatnÃ­ pacienty. Prostor je pravidelnÄ› dezinfikovÃ¡n a vÄ›tranÃ½.</p>
      <ul class="list-disc list-inside space-y-2 mb-4">
        <li>OddÄ›lenÃ½ vstup a ÄekacÃ­ prostor</li>
        <li>ZvÃ½Å¡enÃ¡ hygiena a dezinfekce</li>
        <li>PÅ™Ã­sluÅ¡nÃ© vybavenÃ­ pro akutnÃ­ oÅ¡etÅ™enÃ­</li>
        <li>TeplÃ¡ a pohodlnÃ¡ atmosfÃ©ra</li>
      </ul>
      <p class="text-sm text-gray-600"><strong>Tip:</strong> ObjeÄte se prosÃ­m pÅ™edem, aby jsme mohli sprÃ¡vnÄ› naplÃ¡novat vaÅ¡i nÃ¡vÅ¡tÄ›vu a minimalizovat ÄekÃ¡nÃ­.</p>
    `,
    galleryId: 'cekarna-nemocne'
  },
  {
    id: 'room-healthy',
    title: 'ÄŒekÃ¡rna pro zdravÃ©',
    icon: 'mdi:seat-outline',
    emojiIcon: 'âœ¨',
    description: 'ÄŒekÃ¡rna pro preventivnÃ­ kontroly a oÄkovÃ¡nÃ­',
    detailedContent: `
      <h3 class="text-lg font-bold text-gray-900 mb-3">ÄŒistÃ½ prostor pro zdravÃ© dÄ›ti</h3>
      <p class="mb-4">ÄŒekÃ¡rna pro zdravÃ© dÄ›ti je urÄena pro preventivnÃ­ prohlÃ­dky, oÄkovÃ¡nÃ­ a kontroly zdravÃ½ch dÄ›tÃ­. Prostor je peÄlivÄ› udrÅ¾ovÃ¡n v hygienickÃ½ch standardech.</p>
      <ul class="list-disc list-inside space-y-2 mb-4">
        <li>OddÄ›lenÃ½ prostor bez kontaktu s nemocnÃ½mi</li>
        <li>BezpeÄnÃ© a ÄistÃ© prostÅ™edÃ­</li>
        <li>HraÄky a knihy pro dÄ›ti</li>
        <li>PÅ™Ã­jemnÃ¡ a relaxaÄnÃ­ atmosfÃ©ra</li>
      </ul>
      <p class="text-sm text-gray-600"><strong>Tip:</strong> ObjednÃ¡vka online zrychluje proces a minimalizuje ÄekÃ¡nÃ­.</p>
    `,
    galleryId: 'cekarna-zdrave'
  },
  {
    id: 'room-playroom',
    title: 'DÄ›tskÃ¡ herna',
    icon: 'mdi:teddy-bear',
    emojiIcon: 'ğŸ§¸',
    description: 'Prostor plnÃ½ hraÄek a knih pro zÃ¡bavu dÄ›tÃ­ bÄ›hem ÄekÃ¡nÃ­',
    detailedContent: `
      <h3 class="text-lg font-bold text-gray-900 mb-3">Kdo si hraje â€“ nezlobÃ­</h3>
      <p class="mb-4">HraÄky obnovujeme a snaÅ¾Ã­me se bezpeÄnÄ› dÄ›ti zaujmout a zkrÃ¡tit vÅ¾dy nepÅ™Ã­jemnÃ© ÄekÃ¡nÃ­. DÄ›ti ke hÅ™e ale potÅ™ebujÃ­ i VÃ¡s.</p>
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-4">
        <p class="text-gray-800"><strong>Objevujte jejich Ãºhel pohledu, hrejte si, pÅ¯jÄte si u nÃ¡s knÃ­Å¾ku a ÄtÄ›te si.</strong> Mobily si rÃ¡dy v kabelce odpoÄinou, odpovÄ›di na sms a maily poÄkajÃ­.</p>
      </div>
      <p class="mb-4 text-gray-700"><strong>I poÅ¡Å¥Ã¡k zvonÃ­ dvakrÃ¡t.</strong> A ne â€“ wi-fi nemÃ¡me.</p>
      <h4 class="font-bold text-gray-900 mb-2">VaÅ¡e pomoc je cennÃ¡</h4>
      <p class="mb-2">SestÅ™iÄkÃ¡m pomÅ¯Å¾e, kdyÅ¾ hraÄky zlehka nasmÄ›rujete na pÅ¯vodnÃ­ mÃ­sta. DÄ›kujeme!</p>
      <p class="text-gray-700 font-medium">NauÄit dÄ›ti uklÃ­zet a spontÃ¡nnÄ› pomÃ¡hat je prima.</p>
    `,
    galleryId: 'herna'
  }
];

// Helper funkce pro zÃ­skÃ¡nÃ­ galerie podle ID
function getGallery(id: GalleryId) {
  const galleries = {
    'ordinace-nemocne': ordinaceNemocneGallery,
    'ordinace-zdrave': ordinaceZdraveGallery,
    'cekarna-nemocne': cekarnaNenocneGallery,
    'cekarna-zdrave': cekarnaZdraveGallery,
    'herna': hernaGallery
  };
  return galleries[id];
}
---
<div class="space-y-12">
  <!-- Intro -->
  <div class="max-w-3xl mx-auto text-center">
    <p class="text-lg text-gray-700 leading-relaxed">
      NaÅ¡e ordinace je vybavena <strong class="text-blue-600">dvÄ›ma samostatnÃ½mi ordinaÄnÃ­mi mÃ­stnostmi</strong>
      a <strong class="text-blue-600">ÄekÃ¡rnami</strong>, kterÃ© zajiÅ¡Å¥ujÃ­ maximÃ¡lnÃ­
      <strong class="text-blue-600">hygienu a bezpeÄnost</strong> vÅ¡ech malÃ½ch pacientÅ¯.
    </p>
  </div>

  <!-- Ordinace Cards -->
  <div class="grid md:grid-cols-2 gap-8">
    {facilities.map((facility) => {
      const gallery = getGallery(facility.galleryId);
      const hasImages = gallery.images.length > 0;

      return (
        <div class={`${facility.color.bg} border-2 ${facility.color.border} rounded-2xl overflow-hidden hover:shadow-lg transition-all group`}>
          <!-- Image Placeholder -->
          <div class="relative aspect-video bg-linear-to-br from-gray-100 to-gray-200 flex items-center justify-center overflow-hidden cursor-pointer"
               onclick={hasImages ? `openLightbox_${facility.galleryId}(0)` : null}>
            <div class="absolute inset-0 bg-linear-to-br from-white/50 to-transparent"></div>
            <div class="relative z-10 text-center">
              <Icon name={facility.icon} class={`w-16 h-16 ${facility.color.text} mx-auto mb-2 opacity-30`} />
              <p class="text-gray-500 text-sm font-medium">
                {hasImages ? 'KliknÄ›te pro zobrazenÃ­ galerie' : 'Fotografie pÅ™ipravujeme'}
              </p>
            </div>

            <!-- Gallery Button -->
            <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
              <GalleryButton
                galleryId={facility.galleryId}
                variant="overlay"
                imageCount={gallery.images.length}
              />
            </div>
          </div>

          <!-- Content -->
          <div class="p-6">
            <div class="flex items-start gap-4 mb-4">
              <div class={`${facility.color.iconBg} w-12 h-12 rounded-xl flex items-center justify-center shrink-0 shadow-lg`}>
                <Icon name={facility.icon} class="w-6 h-6 text-white" />
              </div>
              <div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">{facility.title}</h3>
                <p class="text-gray-700 leading-relaxed">{facility.description}</p>
              </div>
            </div>
          </div>
        </div>
      );
    })}
  </div>

  <!-- Waiting Rooms & Playroom -->
  <div class="bg-linear-to-br from-blue-50 to-purple-50 rounded-2xl p-8 border-2 border-blue-100 mt-16">
    <div class="flex items-center gap-3 mb-6">
      <div class="bg-blue-600 w-12 h-12 rounded-xl flex items-center justify-center shadow-lg">
        <Icon name="mdi:door-open" class="w-6 h-6 text-white" />
      </div>
      <h3 class="text-2xl font-bold text-gray-900">DalÅ¡Ã­ prostory ordinace</h3>
    </div>

    <div class="grid md:grid-cols-3 gap-6">
      {waitingRooms.map((room) => {
        const gallery = getGallery(room.galleryId);
        const hasImages = gallery.images.length > 0;

        return (
          <div
            class="bg-white rounded-xl p-6 border border-gray-200 hover:border-blue-400 hover:shadow-lg transition-all cursor-pointer room-card"
            data-modal-id={room.id}
          >
            <div class="bg-linear-to-br from-blue-100 to-purple-100 w-14 h-14 rounded-xl flex items-center justify-center mb-4 mx-auto">
              <span class="text-3xl">{room.emojiIcon}</span>
            </div>
            <h4 class="text-lg font-bold text-gray-900 mb-2 text-center">{room.title}</h4>
            <p class="text-gray-600 text-sm text-center leading-relaxed mb-4">{room.description}</p>

            {/* Bottom section with buttons */}
            <div class="flex justify-center gap-2 flex-wrap">
              <button
                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg text-sm modal-trigger"
                data-modal-id={room.id}
              >
                VÃ­ce info
              </button>
              {hasImages && (
                <GalleryButton
                  galleryId={room.galleryId}
                  variant="secondary"
                  label="Fotky"
                  imageCount={gallery.images.length}
                />
              )}
            </div>
          </div>
        );
      })}
    </div>
    </div>
  </div>

  <!-- Modals for waiting rooms -->
  {waitingRooms.map((room) => (
    <RoomInfoModal
      roomId={room.id}
      title={room.title}
      icon={room.emojiIcon}
      shortDescription={room.description}
      detailedContent={room.detailedContent}
    />
  ))}

  <!-- Info Note -->
  <div class="bg-blue-600 text-white rounded-xl p-6 flex items-start gap-4 mt-8">
    <Icon name="mdi:information-outline" class="w-6 h-6 shrink-0 mt-1" />
    <div>
      <p class="font-medium mb-3">OddÄ›lenÃ© prostory pro maximÃ¡lnÃ­ bezpeÄnost</p>
      <p class="text-blue-100 text-sm leading-relaxed">
        RozdÄ›lenÃ­ nemocnÃ½ch a zdravÃ½ch dÄ›tÃ­ je klÃ­ÄovÃ© pro prevenci Å¡Ã­Å™enÃ­ infekcÃ­. SnaÅ¾Ã­me se o dodrÅ¾enÃ­ tohoto principu jiÅ¾ pÅ™i samotnÃ©m objednÃ¡vÃ¡nÃ­ dÄ›tÃ­. LÃ©pe se pochopitelnÄ› daÅ™Ã­ dodrÅ¾ovat v teplÃ½ch mÄ›sÃ­cÃ­ch roku, hÅ¯Å™e pÅ™i epidemiÃ­ch respiraÄnÃ­ch nÃ¡kaz. StÃ¡lÃ¡ prosba â€“ objednÃ¡vejte se, prosÃ­m, vÅ¾dy! PomÃ¡hÃ¡te tÃ­m nÃ¡m, ale hlavnÄ› sobÄ›. DvÄ› oddÄ›lenÃ© ordinace i ÄekÃ¡rny jsou kaÅ¾dopÃ¡dnÄ› dalÅ¡Ã­m velkÃ½m pomocnÃ­kem v separaci zdravÃ½ch a nemocnÃ½ch dÄ›tÃ­.
      </p>
    </div>
  </div>

<!-- Lightbox modals -->
<Lightbox gallery={ordinaceNemocneGallery} />
<Lightbox gallery={ordinaceZdraveGallery} />
<Lightbox gallery={cekarnaNenocneGallery} />
<Lightbox gallery={cekarnaZdraveGallery} />
<Lightbox gallery={hernaGallery} />

<!-- Global modal handlers -->
<script is:inline>
  // Use astro:page-load instead of DOMContentLoaded for View Transitions compatibility
  function initializeRoomModals() {
    console.log('Room modals: Initializing...');

    // Generic function to open any modal by ID
    function openModal(modalId) {
      const modal = document.getElementById('modal-' + modalId);
      if (modal) {
        console.log('Opening modal:', modalId);
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      } else {
        console.error('Modal not found:', 'modal-' + modalId);
      }
    }

    // Generic function to close any modal by ID
    function closeModal(modalId) {
      const modal = document.getElementById('modal-' + modalId);
      if (modal) {
        console.log('Closing modal:', modalId);
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }

    // Handle clicks on room cards (whole card is clickable)
    const roomCards = document.querySelectorAll('.room-card');
    console.log('Found room cards:', roomCards.length);
    roomCards.forEach(function(card) {
      card.addEventListener('click', function(e) {
        // Don't open modal if clicking on a button or link inside
        if (e.target.closest('.modal-trigger') || e.target.closest('button') || e.target.closest('a')) {
          return;
        }
        const modalId = card.getAttribute('data-modal-id');
        if (modalId) {
          openModal(modalId);
        }
      });
    });

    // Handle clicks on "VÃ­ce info" buttons
    const modalTriggers = document.querySelectorAll('.modal-trigger');
    console.log('Found modal triggers:', modalTriggers.length);
    modalTriggers.forEach(function(trigger) {
      trigger.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent card click
        const modalId = trigger.getAttribute('data-modal-id');
        if (modalId) {
          openModal(modalId);
        }
      });
    });

    // Handle clicks on close buttons inside modals
    const closeButtons = document.querySelectorAll('.modal-close-btn');
    console.log('Found close buttons:', closeButtons.length);
    closeButtons.forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const modalId = btn.getAttribute('data-modal-id');
        if (modalId) {
          closeModal(modalId);
        }
      });
    });

    // Handle clicks on modal overlays (click outside to close)
    const modals = document.querySelectorAll('[id^="modal-room-"]');
    console.log('Found modals:', modals.length);
    modals.forEach(function(modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          const modalId = modal.id.replace('modal-', '');
          closeModal(modalId);
        }
      });
    });

    // Handle Escape key to close modals
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        modals.forEach(function(modal) {
          if (modal.style.display !== 'none') {
            const modalId = modal.id.replace('modal-', '');
            closeModal(modalId);
          }
        });
      }
    });
  }

  // Initialize on first load
  document.addEventListener('DOMContentLoaded', initializeRoomModals);

  // Re-initialize after View Transitions navigation
  document.addEventListener('astro:page-load', initializeRoomModals);
</script>