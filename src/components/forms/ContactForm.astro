---
import { Icon } from 'astro-icon/components';
import { contactInfo } from '../../data/contact';

// Společné CSS třídy pro input fieldy
const inputClasses = "w-full px-4 py-3 rounded-lg bg-white border-2 border-gray-300 placeholder-gray-400 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#5085c6] focus:border-transparent transition-colors";
const labelClasses = "block text-sm font-semibold text-gray-700 mb-2";

// Web3Forms Access Key - MUSÍ být nastavený v .env nebo na hostingu
const WEB3FORMS_ACCESS_KEY = import.meta.env.PUBLIC_WEB3FORMS_KEY;

if (!WEB3FORMS_ACCESS_KEY) {
  throw new Error("PUBLIC_WEB3FORMS_KEY is not defined. Please set it in .env file or hosting environment variables.");
}
---

<div class="bg-linear-to-br from-gray-50 to-[#5085c6]/5 rounded-2xl p-8 border-2 border-[#5085c6]/30 shadow-sm">
  <h2 class="text-3xl font-bold text-gray-900 mb-2">Napište nám</h2>
  <p class="text-gray-600 mb-6">Zanechte nám zprávu a my se vám ozveme co nejdříve</p>

  <!-- Success message (hidden by default) -->
  <div id="form-success" class="hidden mb-6 p-4 bg-green-50 border-2 border-green-500 rounded-lg">
    <div class="flex items-start gap-3">
      <Icon name="mdi:check-circle" class="w-6 h-6 text-green-600 shrink-0 mt-0.5" />
      <div>
        <h3 class="font-bold text-green-900 mb-1">Zpráva byla úspěšně odeslána!</h3>
        <p class="text-green-800 text-sm">Děkujeme za váš dotaz. Na váš email jsme vám zaslali potvrzení. Ozveme se vám co nejdříve.</p>
      </div>
    </div>
  </div>

  <form
    id="contact-form"
    action="https://api.web3forms.com/submit"
    method="POST"
    class="space-y-5"
  >
    <!-- Web3Forms Access Key -->
    <input type="hidden" name="access_key" value={WEB3FORMS_ACCESS_KEY} />

    <!-- Redirect po úspěšném odeslání -->
    <input type="hidden" name="redirect" value="false" />

    <!-- Hlavní email pro příjem zpráv -->
    <input type="hidden" name="from_name" value="Zdravicko Kontakt" />
    <input type="hidden" name="subject" value="Nova zprava z webu" />

    <!-- Honeypot pro spam ochranu -->
    <input type="checkbox" name="botcheck" class="hidden" style="display: none;" />
    <div>
      <label for="name" class={labelClasses}>
        Jméno a příjmení *
      </label>
      <input
        type="text"
        id="name"
        name="name"
        required
        class={inputClasses}
        placeholder="Jan Novák"
      />
    </div>

    <div>
      <label for="email" class={labelClasses}>
        Email *
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        class={inputClasses}
        placeholder="jan.novak@email.cz"
      />
    </div>

    <div>
      <label for="phone" class={labelClasses}>
        Telefon
      </label>
      <input
        type="tel"
        id="phone"
        name="phone"
        class={inputClasses}
        placeholder="+420 123 456 789"
      />
    </div>

    <div>
      <label for="subject" class={labelClasses}>
        Předmět
      </label>
      <select
        id="subject"
        name="subject"
        class={inputClasses}
      >
        <option value="Obecný dotaz">Obecný dotaz</option>
        <option value="Objednání na vyšetření">Objednání na vyšetření</option>
        <option value="Očkování">Očkování</option>
        <option value="Výsledky vyšetření">Výsledky vyšetření</option>
        <option value="Jiné">Jiné</option>
      </select>
    </div>

    <div>
      <label for="message" class={labelClasses}>
        Zpráva *
      </label>
      <textarea
        id="message"
        name="message"
        required
        rows="5"
        class={inputClasses}
        placeholder="Napište nám vaši zprávu..."
      ></textarea>
    </div>

    <!-- GDPR Checkbox -->
    <div class="flex items-start gap-3 p-4 bg-white rounded-lg border border-gray-200">
      <input
        type="checkbox"
        id="gdpr"
        name="gdpr"
        required
        class="mt-1 w-4 h-4 text-primary border-gray-300 rounded focus:ring-2 focus:ring-[#5085c6]"
      />
      <label for="gdpr" class="text-sm text-gray-700">
        Souhlasím se zpracováním osobních údajů pro účely zodpovězení dotazu.
        Vaše data budou zpracována v souladu s <a href="/gdpr" class="text-primary hover:text-primary-600 underline">GDPR</a>
        a nebudou předána třetím stranám. *
      </label>
    </div>

    <button
      type="submit"
      class="w-full bg-[#5085c6] text-white font-semibold px-8 py-4 rounded-lg hover:opacity-90 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2 group"
    >
      <Icon name="mdi:send" class="w-5 h-5 group-hover:translate-x-1 transition-transform" />
      Odeslat zprávu
    </button>

    <p class="text-xs text-gray-500 text-center">
      * Povinná pole
    </p>
  </form>
</div>

<script>
  document.addEventListener('astro:page-load', () => {
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const successMessage = document.getElementById('form-success');

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

        // Disable button during submission
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = '<span class="animate-spin inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span> Odesílám...';
        }

        try {
          const response = await fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            // Show success message
            successMessage?.classList.remove('hidden');
            // Scroll to success message
            successMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Reset form
            form.reset();
          } else {
            alert('Něco se pokazilo. Zkuste to prosím znovu nebo nás kontaktujte telefonicky.');
          }
        } catch (error) {
          alert('Něco se pokazilo. Zkuste to prosím znovu nebo nás kontaktujte telefonicky.');
        } finally {
          // Re-enable button
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" viewBox="0 0 24 24"><path fill="currentColor" d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/></svg> Odeslat zprávu';
          }
        }
      });
    }
  });
</script>
