---
import { Icon } from 'astro-icon/components';
import { contactInfo } from '../../data/contact';

// Spoleƒçn√© CSS t≈ô√≠dy pro input fieldy
const inputClasses = "w-full px-4 py-3 rounded-lg bg-white border-2 border-gray-300 placeholder-gray-400 text-gray-900 focus:outline-none focus:ring-2 focus:ring-[#5085c6] focus:border-transparent transition-colors";
const labelClasses = "block text-sm font-semibold text-gray-700 mb-2";

// Web3Forms Access Key - MUS√ç b√Ωt nastaven√Ω v .env nebo na hostingu
const WEB3FORMS_ACCESS_KEY = import.meta.env.PUBLIC_WEB3FORMS_KEY;

if (!WEB3FORMS_ACCESS_KEY) {
  throw new Error("PUBLIC_WEB3FORMS_KEY is not defined. Please set it in .env file or hosting environment variables.");
}
---

<div class="bg-linear-to-br from-gray-50 to-[#5085c6]/5 rounded-2xl p-8 border-2 border-[#5085c6]/30 shadow-sm">
  <h2 class="text-3xl font-bold text-gray-900 mb-2">Napi≈°te n√°m</h2>
  <p class="text-gray-600 mb-6">Zanechte n√°m zpr√°vu a my se V√°m ozveme co nejd≈ô√≠ve</p>

  <!-- Success message (hidden by default) -->
  <div id="form-success" class="hidden mb-6 p-4 bg-green-50 border-2 border-green-500 rounded-lg">
    <div class="flex items-start gap-3">
      <Icon name="mdi:check-circle" class="w-6 h-6 text-green-600 shrink-0 mt-0.5" />
      <div>
        <h3 class="font-bold text-green-900 mb-1">Zpr√°va byla √∫spƒõ≈°nƒõ odesl√°na!</h3>
        <p class="text-green-800 text-sm">Dƒõkujeme za v√°≈° dotaz. Na v√°≈° email jsme V√°m zaslali potvrzen√≠. Ozveme se V√°m co nejd≈ô√≠ve.</p>
      </div>
    </div>
  </div>

  <form
    id="contact-form"
    action="https://api.web3forms.com/submit"
    method="POST"
    class="space-y-5"
  >
    <!-- Web3Forms Access Key -->
    <input type="hidden" name="access_key" value={WEB3FORMS_ACCESS_KEY} />

    <!-- Redirect po √∫spƒõ≈°n√©m odesl√°n√≠ -->
    <input type="hidden" name="redirect" value="false" />

    <!-- ƒåesk√© labely pro email -->
    <input type="hidden" name="Jm√©no" value="" />
    <input type="hidden" name="Email" value="" />
    <input type="hidden" name="Telefon" value="" />
    <input type="hidden" name="P≈ôedmƒõt" value="" />
    <input type="hidden" name="Zpr√°va" value="" />

    <!-- Honeypot pro spam ochranu -->
    <input type="checkbox" name="botcheck" class="hidden" style="display: none;" />
    <div>
      <label for="name" class={labelClasses}>
        Jm√©no a p≈ô√≠jmen√≠ *
      </label>
      <input
        type="text"
        id="name"
        name="name"
        required
        class={inputClasses}
        placeholder="Jan Nov√°k"
        autocomplete="name"
      />
    </div>

    <div>
      <label for="email" class={labelClasses}>
        Email *
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        class={inputClasses}
        placeholder="vas.email@seznam.cz"
        autocomplete="email"
      />
    </div>

    <div>
      <label for="phone" class={labelClasses}>
        Telefon
      </label>
      <input
        type="tel"
        id="phone"
        name="phone"
        class={inputClasses}
        placeholder="123 456 789"
        pattern="[0-9\s+()-]{9,}"
        title="Zadejte platn√© telefonn√≠ ƒç√≠slo (min. 9 ƒç√≠slic)"
        autocomplete="tel"
      />
    </div>

    <div>
      <label for="subject" class={labelClasses}>
        P≈ôedmƒõt
      </label>
      <select
        id="subject"
        name="subject"
        class={inputClasses}
      >
        <option value="Obecn√Ω dotaz">Obecn√Ω dotaz</option>
        <option value="Objedn√°n√≠ na vy≈°et≈ôen√≠">Objedn√°n√≠ na vy≈°et≈ôen√≠</option>
        <option value="Oƒçkov√°n√≠">Oƒçkov√°n√≠</option>
        <option value="V√Ωsledky vy≈°et≈ôen√≠">V√Ωsledky vy≈°et≈ôen√≠</option>
        <option value="Jin√©">Jin√©</option>
      </select>
    </div>

    <div>
      <label for="message" class={labelClasses}>
        Zpr√°va *
      </label>
      <textarea
        id="message"
        name="message"
        required
        rows="5"
        class={inputClasses}
        placeholder="Napi≈°te n√°m Va≈°i zpr√°vu..."
      ></textarea>
    </div>

    <!-- GDPR Checkbox -->
    <div class="flex items-start gap-3 p-4 bg-white rounded-lg border border-gray-200">
      <input
        type="checkbox"
        id="gdpr"
        name="gdpr"
        required
        class="mt-1 w-4 h-4 text-primary border-gray-300 rounded focus:ring-2 focus:ring-[#5085c6]"
      />
      <label for="gdpr" class="text-sm text-gray-700">
        Souhlas√≠m se zpracov√°n√≠m osobn√≠ch √∫daj≈Ø pro √∫ƒçely zodpovƒõzen√≠ dotazu.
        Va≈°e data budou zpracov√°na v souladu s <a href="/gdpr" class="text-primary hover:text-primary-600 underline">GDPR</a>
        a nebudou p≈ôed√°na t≈ôet√≠m stran√°m. *
      </label>
    </div>

    <button
      type="submit"
      class="w-full bg-[#5085c6] text-white font-semibold px-8 py-4 rounded-lg hover:opacity-90 transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2 group"
    >
      <Icon name="mdi:send" class="w-5 h-5 group-hover:translate-x-1 transition-transform" />
      Odeslat zpr√°vu
    </button>

    <p class="text-xs text-gray-500 text-center">
      * Povinn√° pole
    </p>
  </form>
</div>

<script>
  document.addEventListener('astro:page-load', () => {
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const successMessage = document.getElementById('form-success');

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

        // Z√≠sk√°me hodnoty z formul√°≈ôe
        const userName = formData.get('name') as string || 'Nezn√°m√Ω odes√≠latel';
        const userEmail = formData.get('email') as string;
        const userPhone = formData.get('phone') as string;
        const subjectType = formData.get('subject') as string || 'Obecn√Ω dotaz';
        const message = formData.get('message') as string;

        // Nastav√≠me from_name a subject pro hlaviƒçku emailu
        formData.set('from_name', `${userName} (Zdravicko.org)`);
        formData.set('subject', `ü©∫ ${subjectType} - ${userName}`);

        // P≈ôid√°me ƒçesk√° pole (p≈ôep√≠≈°eme hidden fieldy s pr√°zdnou hodnotou)
        formData.set('Jm√©no', userName);
        formData.set('Email', userEmail);
        formData.set('Telefon', userPhone || '-');
        formData.set('P≈ôedmƒõt', subjectType);
        formData.set('Zpr√°va', message);

        // Odstran√≠me anglick√° pole (aby se nezobrazovala v emailu)
        formData.delete('name');
        formData.delete('email');
        formData.delete('phone');
        formData.delete('message');
        // 'subject' nech√°me, proto≈æe se pou≈æ√≠v√° pro hlaviƒçku

        // Disable button during submission
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = '<span class="animate-spin inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span> Odes√≠l√°m...';
        }

        try {
          const response = await fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            // Show success message
            successMessage?.classList.remove('hidden');
            // Scroll to success message
            successMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Reset form
            form.reset();
          } else {
            alert('‚ùå Nepoda≈ôilo se odeslat zpr√°vu. Zkuste to pros√≠m znovu nebo n√°s kontaktujte telefonicky na +420 776 287 820.');
          }
        } catch (error) {
          console.error('Form submission error:', error);
          alert('‚ùå Nepoda≈ôilo se odeslat zpr√°vu. Zkuste to pros√≠m znovu nebo n√°s kontaktujte telefonicky na +420 776 287 820.');
        } finally {
          // Re-enable button
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" viewBox="0 0 24 24"><path fill="currentColor" d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/></svg> Odeslat zpr√°vu';
          }
        }
      });
    }
  });
</script>
