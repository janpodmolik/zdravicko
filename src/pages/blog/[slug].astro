---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/common/Header.astro';
import MobileMenu from '../../components/common/MobileMenu.astro';
import HorizontalCarousel from '../../components/common/HorizontalCarousel.astro';
import BlogCard from '../../components/cards/BlogCard.astro';
import Footer from '../../components/common/Footer.astro';
import { Icon } from 'astro-icon/components';
import type { CollectionEntry } from 'astro:content';
import { formatDate } from '../../utils/dateFormat';
import { getPublishedBlogPosts, blogEntryToCardData } from '../../utils/contentHelpers';

export async function getStaticPaths() {
  const blogPosts = await getPublishedBlogPosts();
  return blogPosts.map((post: CollectionEntry<'blog'>) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

const RELATED_POSTS_COUNT = 3;
const CHEVRON_ICON = 'mdi:chevron-right';
const ACCOUNT_ICON = 'mdi:account-circle';
const CALENDAR_ICON = 'mdi:calendar';

const allPosts = await getPublishedBlogPosts();
const relatedPosts = allPosts
  .filter((p: CollectionEntry<'blog'>) => p.slug !== post.slug)
  .slice(0, RELATED_POSTS_COUNT);
---

<Layout
  title={`${post.data.title} - Blog | Zdravíčko`}
  description={post.data.excerpt}
>
  <Header activePage="blog" />
  <MobileMenu activePage="blog" />

  <section class="bg-gray-50 py-4">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <nav class="flex items-center gap-2 text-sm text-gray-600">
          <a href="/" class="hover:text-blue-600 transition-colors">Domů</a>
          <Icon name={CHEVRON_ICON} class="w-4 h-4" />
          <a href="/blog" class="hover:text-blue-600 transition-colors">Blog</a>
          <Icon name={CHEVRON_ICON} class="w-4 h-4" />
          <span class="text-gray-900 font-medium">{post.data.title}</span>
        </nav>
      </div>
    </div>
  </section>

  <article class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto">
        <header class="mb-12">
          <div class="mb-6">
            <span class="bg-blue-100 text-blue-600 px-4 py-2 rounded-full text-sm font-semibold">
              {post.data.category}
            </span>
          </div>

          <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
            {post.data.title}
          </h1>

          <div class="flex flex-wrap items-center gap-6 text-gray-600">
            <div class="flex items-center gap-2">
              <Icon name={ACCOUNT_ICON} class="w-5 h-5" />
              <span>{post.data.author}</span>
            </div>
            <div class="flex items-center gap-2">
              <Icon name={CALENDAR_ICON} class="w-5 h-5" />
              <time datetime={post.data.date.toISOString()}>
                {formatDate(post.data.date.toISOString())}
              </time>
            </div>
          </div>
        </header>

        {post.data.image && (
          <div class="mb-12">
            <img
              src={post.data.image}
              alt={post.data.title}
              class="w-full h-96 object-cover rounded-2xl shadow-lg"
            />
          </div>
        )}

        <div class="prose prose-lg max-w-none">
          <div class="
            [&>h2]:text-3xl [&>h2]:font-bold [&>h2]:text-gray-900 [&>h2]:mt-12 [&>h2]:mb-6
            [&>h3]:text-2xl [&>h3]:font-bold [&>h3]:text-gray-900 [&>h3]:mt-8 [&>h3]:mb-4
            [&>p]:text-gray-700 [&>p]:leading-relaxed [&>p]:mb-6
            [&>ul]:list-disc [&>ul]:ml-6 [&>ul]:mb-6 [&>ul]:space-y-2
            [&>li]:text-gray-700 [&>li]:leading-relaxed
            [&>strong]:text-gray-900 [&>strong]:font-semibold
          ">
            <Content />
          </div>
        </div>
      </div>
    </div>
  </article>

  {relatedPosts.length > 0 && (
    <HorizontalCarousel
      id="related-posts"
      title="Mohlo by vás zajímat"
      description="Další užitečné články z našeho blogu"
      ctaText="Zpět na blog"
      ctaLink="/blog"
      bgColor="gray"
    >
      {relatedPosts.map(post => (
        <BlogCard post={post} variant="carousel" />
      ))}
    </HorizontalCarousel>
  )}

  <Footer />
</Layout>
