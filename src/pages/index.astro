---
import Layout from '../layouts/Layout.astro';
import Header from '../components/common/Header.astro';
import MobileMenu from '../components/common/MobileMenu.astro';
import Hero from '../components/home/Hero.astro';
import QuickInfo from '../components/home/QuickInfo.astro';
import SpecialNotice from '../components/home/SpecialNotice.astro';
import About from '../components/home/About.astro';
import HorizontalCarousel from '../components/common/HorizontalCarousel.astro';
import ServiceCard from '../components/cards/ServiceCardCarousel.astro';
import BlogCard from '../components/cards/BlogCard.astro';
import NewsCard from '../components/cards/NewsCard.astro';
import OpeningHours from '../components/home/OpeningHours.astro';
import Contact from '../components/home/Contact.astro';
import Footer from '../components/common/Footer.astro';

import { getTodayOpeningHours } from '../utils/openingHours';
import { getPublishedNews, getPublishedBlogPosts } from '../utils/contentHelpers';
import { getCollection } from 'astro:content';
import type { ServiceColor } from '../data/services';

const todayInfo = getTodayOpeningHours();
const latestNews = (await getPublishedNews()).slice(0, 3);
const latestBlogPosts = (await getPublishedBlogPosts()).slice(0, 3);

// Načíst služby pro homepage
const allServices = await getCollection('services', ({ data }) => {
  return data.published !== false && data.showOnHomepage === true;
});
const homepageServices = allServices
  .sort((a, b) => (a.data.order || 999) - (b.data.order || 999))
  .map(service => ({
    id: service.id,
    title: service.data.title,
    slug: service.slug,
    excerpt: service.data.excerpt,
    description: service.data.excerpt,
    icon: service.data.icon,
    color: service.data.color as ServiceColor,
    features: service.data.features,
    showOnHomepage: service.data.showOnHomepage,
  }));
---

<Layout title="Zdravíčko - Dětská ordinace | Kvalitní péče o vaše děti">
  <Header activePage="home" />
  <MobileMenu activePage="home" />

  <Hero />
  <QuickInfo todayInfo={todayInfo} />

  <SpecialNotice />

  <!-- Aktuality Carousel -->
  {latestNews.length > 0 && (
    <HorizontalCarousel
      id="aktuality"
      title="Aktuality"
      description="Aktuální informace z naší ordinace"
      ctaText="Všechny aktuality"
      ctaLink="/aktuality"
      bgColor="gray"
    >
      {latestNews.map(news => (
        <NewsCard news={news} />
      ))}
    </HorizontalCarousel>
  )}

  <!-- Služby Carousel -->
  <HorizontalCarousel
    id="sluzby"
    title="Naše služby"
    description="Poskytujeme kompletní péči pro vaše děti"
    ctaText="Všechny služby"
    ctaLink="/sluzby"
    bgColor="white"
  >
    {homepageServices.map(service => (
      <ServiceCard
        icon={service.icon}
        title={service.title}
        description={service.excerpt}
        href={`/sluzby/${service.slug}`}
        color={service.color}
      />
    ))}
  </HorizontalCarousel>

  <!-- Blog Carousel -->
  {latestBlogPosts.length > 0 && (
    <HorizontalCarousel
      id="blog"
      title="Z našeho blogu"
      description="Užitečné rady a informace pro rodiče"
      ctaText="Všechny články"
      ctaLink="/blog"
      bgColor="gray"
    >
      {latestBlogPosts.map(post => (
        <BlogCard post={post} variant="carousel" />
      ))}
    </HorizontalCarousel>
  )}

  <About />
  <OpeningHours />
  <Contact />

  <Footer />

  <!-- Netlify Identity redirect handler - pouze na homepage -->
  <script is:inline>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>
</Layout>
